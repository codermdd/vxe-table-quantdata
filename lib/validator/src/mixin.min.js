"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);var i=r.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"content",get:function(){return _tools.UtilTools.getFuncText(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}]),t}(),_default={methods:{_fullValidate:function(e,t){return this.beginValidate(e,t,!0)},_validate:function(e,t){return this.beginValidate(e,t)},handleValidError:function(e){var t=this;!1===this.validOpts.autoPos?this.emitEvent("valid-error",e):this.handleActived(e,{type:"valid-error",trigger:"call"}).then(function(){return setTimeout(function(){return t.showValidTooltip(e)},10)})},beginValidate:function(e,u,o){var t,s=this,c={},l=this.editRules,f=this.afterFullData,d=this.treeConfig,r=this.treeOpts;!0===e?t=f:e&&(_ctor.default.isFunction(e)?u=e:t=_ctor.default.isArray(e)?e:[e]),t||(t="obsolete"===_conf.default.validFullData?f:this.getInsertRecords().concat(this.getUpdateRecords()));var h=!0,n=[];if(this.lastCallTime=Date.now(),this.validRuleErr=!1,this.clearValidate(),l){var a=this.getColumns(),i=function(i){if(o||!s.validRuleErr){var e=[];a.forEach(function(r){!o&&s.validRuleErr||!_ctor.default.has(l,r.property)||e.push(s.validCellRules("all",i,r).catch(function(e){var t={rule:e.rule,rules:e.rules,rowIndex:s.getRowIndex(i),row:i,columnIndex:s.getColumnIndex(r),column:r,$table:s};if(c[r.property]||(c[r.property]=[]),c[r.property].push(t),!o)return s.validRuleErr=!0,Promise.reject(t)}))}),n.push(Promise.all(e))}};return d?_ctor.default.eachTree(t,i,r):t.forEach(i),Promise.all(n).then(function(){var e=Object.keys(c);return s.$nextTick().then(function(){if(e.length)return Promise.reject(c[e[0]][0]);u&&("obsolete"===_conf.default.validArgs?u(h):u())})}).catch(function(a){return new Promise(function(e,t){var r=function(){s.$nextTick(function(){h=!1,u?("obsolete"===_conf.default.validArgs?u(h,c):u(c),e()):t(c)})},i=function(){a.cell=s.getCell(a.row,a.column),_tools.DomTools.toView(a.cell),s.handleValidError(a),r()},o=a.row,l=f.indexOf(o),n=0<l?f[l-1]:o;!1===s.validOpts.autoPos?r():d?s.scrollToTreeRow(n).then(i):s.scrollToRow(n).then(i)})})}return this.$nextTick().then(function(){u&&("obsolete"===_conf.default.validArgs?u(h):u())})},hasCellRules:function(t,e,r){var i=this.editRules,o=r.property;if(o&&i){var l=_ctor.default.get(i,o);return l&&_ctor.default.find(l,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},validCellRules:function(l,n,a,e){var u=this,t=this.editRules,r=a.property,s=[],c=[];if(r&&t){var f=_ctor.default.get(t,r);if(f){var d=_ctor.default.isUndefined(e)?_ctor.default.get(n,r):e;f.forEach(function(r){if("all"===l||!r.trigger||l===r.trigger)if(_ctor.default.isFunction(r.validator)){var e;(e="obsolete"===_conf.default.validArgs?new Promise(function(t){r.validator(r,d,function(e){_ctor.default.isError(e)&&(u.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e.message,rule:new Rule(r)}))),t()},{rule:r,rules:f,row:n,column:a,rowIndex:u.getRowIndex(n),columnIndex:u.getColumnIndex(a),$table:u})}):r.validator({cellValue:d,rule:r,rules:f,row:n,rowIndex:u.getRowIndex(n),column:a,columnIndex:u.getColumnIndex(a),$table:u}))&&(_ctor.default.isError(e)?(u.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e.message,rule:new Rule(r)}))):e.catch&&c.push(e.catch(function(e){u.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e&&e.message?e.message:r.content||r.message,rule:new Rule(r)}))})))}else{var t="number"===r.type,i="array"===r.type,o=t?_ctor.default.toNumber(d):_ctor.default.getSize(d);!r.required||(i?_ctor.default.isArray(d)&&d.length:null!=d&&""!==d)?(t&&isNaN(d)||!isNaN(r.min)&&o<parseFloat(r.min)||!isNaN(r.max)&&o>parseFloat(r.max)||r.pattern&&!(r.pattern.test?r.pattern:new RegExp(r.pattern)).test(d))&&(u.validRuleErr=!0,s.push(new Rule(r))):(u.validRuleErr=!0,s.push(new Rule(r)))}})}}return Promise.all(c).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},_clearValidate:function(){var e=this.$refs.validTip;return Object.assign(this.validStore,{visible:!1,row:null,column:null,content:"",rule:null}),e&&e.visible&&e.close(),this.$nextTick()},triggerValidate:function(i){var o=this,e=this.editConfig,t=this.editStore,r=this.editRules,l=this.validStore,n=t.actived;if(n.row&&r){var a=n.args,u=a.row,s=a.column,c=a.cell;if(this.hasCellRules(i,u,s))return this.validCellRules(i,u,s).then(function(){"row"===e.mode&&l.visible&&l.row===u&&l.column===s&&o.clearValidate()}).catch(function(e){var t=e.rule;if(t.trigger&&i!==t.trigger)return Promise.resolve();var r={rule:t,row:u,column:s,cell:c};return o.showValidTooltip(r),Promise.reject(r)})}return Promise.resolve()},showValidTooltip:function(e){var t=this,r=this.$refs,i=this.height,o=this.tableData,l=this.validOpts,n=e.rule,a=e.row,u=e.column,s=e.cell,c=r.validTip,f=n.message;this.$nextTick(function(){Object.assign(t.validStore,{row:a,column:u,rule:n,content:f,visible:!0}),c&&("tooltip"===l.message||"default"===l.message&&!i&&o.length<2)&&c.open(s,f),t.emitEvent("valid-error",e)})}}};exports.default=_default;